<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Full API Defense Panel</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>

    <nav>
        <a href="/">Home</a>
        <a href="/about">About</a>
        <a href="/contact">Contact</a>
        <a href="/search?q=tokyo">Search</a>
        <a href="/item/1">Item</a>
        <a href="/api/info">API Info</a>
        <a href="/test">API Test Page</a> 
    </nav>

    <div class="container">
        <header style="border:none; box-shadow:none; padding:0; display:flex; justify-content:space-between; align-items:center;">
            <h1>API Defense & Admin Panel</h1>
            <button class="btn-delete-all" onclick="deleteAll()">⚠️ DELETE ALL</button>
        </header>

        <section class="panel">
            <h2 id="form-title">1. Create / Update</h2>
            <div class="form-row">
                <input type="text" id="p-name" placeholder="City Name" required>
                <select id="p-category">
                    <option value="Europe">Europe</option>
                    <option value="Asia">Asia</option>
                    <option value="America">America</option>
                    <option value="Africa">Africa</option>
                </select>
            </div>
            <div class="form-row">
                <input type="text" id="p-desc" placeholder="Description">
                <input type="text" id="p-img" placeholder="Image URL">
            </div>
            <button id="btn-submit" class="btn-create" onclick="handleFormSubmit()">Create (POST)</button>
            <button id="btn-cancel" class="btn-cancel" onclick="resetForm()">Cancel</button>
        </section>

        <section class="panel" style="background-color: #fff3e0; border-color: #ffe0b2;">
            <h2>2. API Laboratory (Test Specific Requirements)</h2>
            <p>Use this section to prove specific grading criteria.</p>
            
            <div class="form-row">
                <input type="text" id="test-id" placeholder="Paste ID here to test GET /:id">
                <button class="btn-lab" onclick="testGetById()">Test GET By ID</button>
            </div>

            <div class="form-row">
                <input type="text" id="test-fields" value="name,category" placeholder="Fields (e.g. name,category)">
                <button class="btn-lab" onclick="testProjection()">Test Projection</button>
            </div>

             <div class="form-row">
                <select id="test-sort">
                    <option value="name">Sort by Name</option>
                    <option value="category">Sort by Category</option>
                </select>
                <button class="btn-lab" onclick="testSort()">Test Sorting</button>
            </div>

            <div id="json-output" class="lab-panel">// JSON Result will appear here...</div>
        </section>

        <section>
            <h2>3. Database Overview (GET All)</h2>
            <div class="table-container">
                <div id="output">Loading...</div>
            </div>
        </section>
    </div>

    <script>
        let currentEditingId = null;

        // --- ЛОГИКА ТЕСТОВ (LABORATORY) ---

        // 1. Test GET /api/items/:id
        async function testById() {
            const id = document.getElementById('test-id').value.trim();
            if(!id) return alert("Paste an ID first!");
            
            showJson("Loading...");
            try {
                const res = await fetch(`/api/items/${id}`);
                const data = await res.json();
                showJson(data);
            } catch(e) { showJson({error: e.message}); }
        }

        // 2. Test GET /api/items?fields=... (Projection)
        async function testProjection() {
            const fields = document.getElementById('test-fields').value.trim();
            showJson(`Requesting: /api/items?fields=${fields}`);
            try {
                const res = await fetch(`/api/items?fields=${fields}`);
                const data = await res.json();
                showJson(data);
            } catch(e) { showJson({error: e.message}); }
        }

        // 3. Test GET /api/items?sort=... (Sorting)
        async function testSort() {
            const sort = document.getElementById('test-sort').value;
            showJson(`Requesting: /api/items?sort=${sort}`);
            try {
                const res = await fetch(`/api/items?sort=${sort}`);
                const data = await res.json();
                showJson(data);
            } catch(e) { showJson({error: e.message}); }
        }
        
        // 4. Test GET By ID
        async function testGetById() {
             const id = document.getElementById('test-id').value.trim();
            if(!id) return alert("Paste an ID first!");
            
            showJson(`Requesting: /api/items/${id}`);
            try {
                const res = await fetch(`/api/items/${id}`);
                const data = await res.json();
                showJson(data);
            } catch(e) { showJson({error: e.message}); }
        }

        function showJson(data) {
            document.getElementById('json-output').innerText = JSON.stringify(data, null, 2);
        }


        // --- ОБЫЧНАЯ ЛОГИКА (ТАБЛИЦА И CRUD) ---

        async function loadData() {
            const container = document.getElementById('output');
            try {
                const res = await fetch('/api/items');
                const data = await res.json();
                
                if (data.length === 0) {
                    container.innerHTML = '<p>Empty Database</p>'; return;
                }

                let html = `<table class="data-table"><thead><tr>
                    <th>City</th><th>Cat</th><th>ID (Copy this for tests)</th><th>Actions</th>
                    </tr></thead><tbody>`;

                data.forEach(item => {
                    const itemJson = JSON.stringify(item).replace(/"/g, '&quot;');
                    html += `<tr>
                        <td><b>${item.name}</b></td>
                        <td>${item.category}</td>
                        <td style="font-family:monospace; cursor:pointer;" onclick="copyId('${item._id}')" title="Click to copy">${item._id}</td>
                        <td>
                            <button style="background:#ffbb33; color:black; padding:5px;" onclick="startEdit(${itemJson})">Edit</button>
                            <button style="background:#d32f2f; padding:5px;" onclick="deleteItem('${item._id}')">Del</button>
                        </td>
                    </tr>`;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;
            } catch (err) { console.error(err); }
        }

        async function handleFormSubmit() {
            const data = {
                name: document.getElementById('p-name').value,
                category: document.getElementById('p-category').value,
                description: document.getElementById('p-desc').value,
                img: document.getElementById('p-img').value
            };
            if (!data.name) return alert("Name required");

            if (currentEditingId) {
                await fetch(`/api/items/${currentEditingId}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)});
            } else {
                await fetch('/api/items', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)});
            }
            resetForm(); loadData();
        }

        function startEdit(item) {
            currentEditingId = item._id;
            document.getElementById('p-name').value = item.name;
            document.getElementById('p-category').value = item.category;
            document.getElementById('p-desc').value = item.description || "";
            document.getElementById('p-img').value = item.img || "";
            
            document.getElementById('btn-submit').innerText = "Save (PUT)";
            document.getElementById('btn-submit').className = "btn-update";
            document.getElementById('btn-submit').style.display = "inline-block";
            document.getElementById('btn-cancel').style.display = "inline-block";
            
            // Также копируем ID в поле теста для удобства
            document.getElementById('test-id').value = item._id;
        }

        function resetForm() {
            currentEditingId = null;
            document.getElementById('p-name').value = '';
            document.getElementById('p-desc').value = '';
            document.getElementById('p-img').value = '';
            document.getElementById('btn-submit').innerText = "Create (POST)";
            document.getElementById('btn-submit').className = "btn-create";
            document.getElementById('btn-cancel').style.display = "none";
        }

        async function deleteItem(id) {
            if(confirm('Delete?')) { await fetch(`/api/items/${id}`, { method: 'DELETE' }); loadData(); }
        }
        
        async function deleteAll() {
            if(prompt("Type DELETE") === 'DELETE') { await fetch('/api/items/all', { method: 'DELETE' }); loadData(); }
        }

        function copyId(id) {
            document.getElementById('test-id').value = id;
            alert("ID copied to Laboratory box: " + id);
        }

        loadData();
    </script>
</body>
</html>