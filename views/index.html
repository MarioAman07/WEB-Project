<!-- views/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Travel Planner - Destinations</title>
  <link rel="stylesheet" href="/style.css" />
</head>

<body>
  <nav>
    <a href="/">Home</a>
    <a href="/about">About</a>
    <a href="/contact">Contact</a>
    <a href="/search?q=tokyo">Search</a>
    <a href="/item/1">Item</a>
    <a href="/api/info">API Info</a>
    <a href="/test">Role Test Panel</a>
    <a href="/login">Login</a>
    <a href="/register">Register</a>
    <button onclick="logout()">Logout</button>
  </nav>

  <header>
    <h1>Travel Planner</h1>
    <p>Explore destinations and plan your next adventure.</p>
  </header>

  <section>
    <h2>Browse Destinations</h2>
    <div id="category-buttons" class="filter-buttons"></div>
    <div id="destinations-grid" class="grid-container"></div>
  </section>

  <section id="favorites-section" class="favorites-section">
    <h2>My Favorite Destinations</h2>
    <div id="favorites-grid" class="grid-container"></div>
  </section>

  <section id="reviews-section" class="reviews-section">
    <h2>Traveler Reviews</h2>
    <div id="reviews-container"></div>

    <div class="review-form">
      <h3>Share your experience:</h3>
      <input type="text" id="reviewer-name" placeholder="Your Name" required />
      <textarea id="review-text" placeholder="Write your review..." rows="4" required></textarea>
      <button onclick="submitReview()">Submit Review</button>
    </div>
  </section>

  <footer>
    <div class="footer-text">
      <h2>Worldwide Group Tours & European River Cruises</h2>
      <p>2026 Christmas market river cruises now available to book.</p>
    </div>
  </footer>

  <script>
    let destinations = [];
    let favorites = JSON.parse(localStorage.getItem("favs")) || [];
    let reviews = JSON.parse(localStorage.getItem("reviews")) || [];

    // -----------------------------
    // ✅ Utility: XSS safe text
    // -----------------------------
    function escapeHTML(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // -----------------------------
    // ✅ Utility: safe image
    // -----------------------------
    function safeImageUrl(url) {
      const u = (url && String(url).trim()) ? String(url).trim() : "";
      // If empty → placeholder immediately
      return u || "https://via.placeholder.com/800x500?text=No+Image";
    }

    // -----------------------------
    // ✅ Load from backend MongoDB
    // -----------------------------
    async function loadDestinations() {
      try {
        const res = await fetch("/api/items");
        if (!res.ok) throw new Error(await res.text());
        destinations = await res.json();

        renderCategoryButtons();
        renderDestinations("all");
        renderFavorites();
        renderReviews();
      } catch (err) {
        console.error(err);
        const btns = document.getElementById("category-buttons");
        if (btns) btns.innerHTML = "";
        const grid = document.getElementById("destinations-grid");
        if (grid) grid.innerHTML = `<p style="color:red;">Error loading destinations from API.</p>`;
      }
    }

    function renderCategoryButtons() {
      const container = document.getElementById("category-buttons");
      if (!container) return;

      const categories = Array.from(
        new Set(destinations.map(d => d.category).filter(Boolean))
      ).sort();

      container.innerHTML = `<button onclick="filterDestinations('all')">All</button>`;

      categories.forEach(cat => {
        const safeCat = String(cat).replace(/'/g, "\\'");
        container.innerHTML += `<button onclick="filterDestinations('${safeCat}')">${escapeHTML(cat)}</button>`;
      });
    }

    // -----------------------------
    // ✅ Render Destinations (fixed layout)
    // -----------------------------
    function renderDestinations(filter = "all") {
      const grid = document.getElementById("destinations-grid");
      if (!grid) return;

      grid.innerHTML = "";

      const filtered =
        filter === "all"
          ? destinations
          : destinations.filter((d) => d.category === filter);

      if (filtered.length === 0) {
        grid.innerHTML = `<p>No destinations found for this category.</p>`;
        return;
      }

      filtered.forEach((d) => {
        const name = escapeHTML(d.name || "Untitled Destination");
        const category = escapeHTML(d.category || "-");
        const location = escapeHTML(d.location || "-");
        const description = escapeHTML(d.description || "No description provided.");
        const price = (d.price ?? "-");
        const rating = (d.rating ?? "-");
        const imgSrc = safeImageUrl(d.img);

        grid.innerHTML += `
          <div class="card">
            <img
              src="${imgSrc}"
              alt="${name}"
              loading="lazy"
              onerror="this.onerror=null; this.src='https://via.placeholder.com/800x500?text=No+Image';"
            />
            <div class="card-content">
              <h3>${name}</h3>
              <p><strong>Category:</strong> ${category}</p>
              <p><strong>Location:</strong> ${location}</p>
              <p><strong>Price:</strong> $${price}</p>
              <p><strong>Rating:</strong> ${rating}/5</p>
              <p class="desc">${description}</p>
              <button onclick="addToFavorites('${d._id}')">❤ Save</button>
            </div>
          </div>
        `;
      });
    }

    function filterDestinations(cat) {
      renderDestinations(cat);
    }

    // -----------------------------
    // ✅ Favorites (localStorage)
    // -----------------------------
    function addToFavorites(id) {
      const item = destinations.find((d) => d._id === id);
      if (!item) return;

      if (!favorites.find((f) => f._id === id)) {
        favorites.push(item);
        localStorage.setItem("favs", JSON.stringify(favorites));
        renderFavorites();
      }
    }

    function removeFromFavorites(id) {
      favorites = favorites.filter((f) => f._id !== id);
      localStorage.setItem("favs", JSON.stringify(favorites));
      renderFavorites();
    }

    function renderFavorites() {
      const favGrid = document.getElementById("favorites-grid");
      if (!favGrid) return;

      favGrid.innerHTML = "";

      if (favorites.length === 0) {
        favGrid.innerHTML = `<p>No favorites yet. Click ❤ Save to add.</p>`;
        return;
      }

      favorites.forEach((f) => {
        const name = escapeHTML(f.name || "-");
        const location = escapeHTML(f.location || "");
        const imgSrc = safeImageUrl(f.img);

        favGrid.innerHTML += `
          <div class="card">
            <img
              src="${imgSrc}"
              alt="${name}"
              loading="lazy"
              onerror="this.onerror=null; this.src='https://via.placeholder.com/800x500?text=No+Image';"
            />
            <div class="card-content">
              <h3>${name}</h3>
              <p>${location}</p>
              <button class="remove-btn" onclick="removeFromFavorites('${f._id}')">Remove</button>
            </div>
          </div>
        `;
      });
    }

    // -----------------------------
    // ✅ Reviews (localStorage)
    // -----------------------------
    function submitReview() {
      const reviewerName = document.getElementById("reviewer-name").value.trim();
      const reviewText = document.getElementById("review-text").value.trim();

      if (reviewerName && reviewText) {
        reviews.push({ name: reviewerName, text: reviewText });
        localStorage.setItem("reviews", JSON.stringify(reviews));
        renderReviews();

        document.getElementById("reviewer-name").value = "";
        document.getElementById("review-text").value = "";
      }
    }

    function renderReviews() {
      const reviewContainer = document.getElementById("reviews-container");
      if (!reviewContainer) return;

      reviewContainer.innerHTML = "";

      if (reviews.length === 0) {
        reviewContainer.innerHTML = `<p>No reviews yet. Be the first!</p>`;
        return;
      }

      reviews.forEach((review) => {
        const safeName = escapeHTML(review.name);
        const safeText = escapeHTML(review.text);

        reviewContainer.innerHTML += `
          <div class="review">
            <p><strong>${safeName}:</strong> "${safeText}"</p>
          </div>
        `;
      });
    }

    // -----------------------------
    // ✅ Logout
    // -----------------------------
    async function logout() {
      const res = await fetch("/logout", { method: "POST" });
      if (res.ok) window.location.href = "/";
    }

    // -----------------------------
    // ✅ Start
    // -----------------------------
    loadDestinations();
    renderFavorites();
    renderReviews();
  </script>
</body>
</html>
